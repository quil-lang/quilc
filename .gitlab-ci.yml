stages:
  - test
  - package

test-cl-quil:
  stage: test
  tags:
    - github
  only:
    - branches
  image: rigetti/quicklisp
  script:
    - make dump-version-info
    - make install-test-deps
    - make test-cl-quil

test-quilc:
  stage: test
  tags:
    - github
  only:
    - branches
  image: rigetti/quicklisp
  script:
    - make dump-version-info
    - make install-test-deps
    # clone rpcq to work around QuickLisp
    - pushd /builds/rigetti && rm -rf rpcq && git clone https://github.com/rigetti/rpcq.git && popd
    - make test-quilc

docker-edge:
  stage: package
  tags:
    - dockerd
    - github
  only:
    - master
  image: docker:stable
  script:
    - docker build --tag rigetti/quilc:${CI_COMMIT_SHORT_SHA} --tag rigetti/quilc:edge .
    - echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
    - docker push rigetti/quilc:${CI_COMMIT_SHORT_SHA} && docker push rigetti/quilc:edge
    - docker rmi rigetti/quilc:${CI_COMMIT_SHORT_SHA} rigetti/quilc:edge

docker-branch:
  stage: package
  tags:
    - dockerd
    - github
  only:
    - branches
  except:
    - master
  image: docker:stable
  script:
    - docker build --tag rigetti/quilc:${CI_COMMIT_REF_SLUG} .
    - echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
    - docker push rigetti/quilc:${CI_COMMIT_REF_SLUG}
    - docker rmi rigetti/quilc:${CI_COMMIT_REF_SLUG}

docker-vtag:
  stage: package
  tags:
    - dockerd
    - github
  # matches only on tags of the form vX.Y.Z
  only:
    - /^v(\d+\.)?(\d+\.)?(\d+)$/
  except:
    - branches
  image: docker:stable
  script:
    - export VERSION=`cat VERSION.txt`
    # make sure tag matches VERSION.txt
    - if [ "${CI_COMMIT_TAG}" = "v${VERSION}" ]; then return 0; else return 1; fi
    - docker build --tag rigetti/quilc:$VERSION --tag rigetti/quilc:stable --tag rigetti/quilc:latest .
    - echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
    - docker push rigetti rigetti/quilc:$VERSION && docker push rigetti/quilc:stable && docker push rigetti/quilc:latest
    - docker rmi rigetti/quilc:$VERSION rigetti/quilc:stable rigetti/quilc:latest
