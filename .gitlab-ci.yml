stages:
  - test
  - package

test-cl-quil:
  stage: test
  tags:
    - github
  only:
    - branches
  image: rigetti/quicklisp
  script:
    - make dump-version-info
    - make install-test-deps
    - make test-cl-quil

test-quilc:
  stage: test
  tags:
    - github
  only:
    - branches
  image: rigetti/quicklisp
  script:
    - make dump-version-info
    - make install-test-deps
    # clone rpcq to work around QuickLisp
    - pushd /builds/rigetti && rm -rf rpcq && git clone https://github.com/rigetti/rpcq.git && popd
    - make test-quilc

docker-master:
  stage: package
  tags:
    - dockerd
    - github
  only:
    - master
  image: docker:stable
  script:
    - docker build --tag rigetti/quilc:${CI_COMMIT_SHORT_SHA} --tag rigetti/quilc:latest .
    - echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
    - docker push rigetti/quilc && docker rmi -f rigetti/quilc:latest

docker-branch:
  stage: package
  tags:
    - dockerd
    - github
  only:
    - branches
  except:
    - master
  image: docker:stable
  script:
    - docker build --tag rigetti/quilc:${CI_COMMIT_REF_SLUG} .
    - echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
    - docker push rigetti/quilc && docker rmi -f rigetti/quilc:${CI_COMMIT_REF_SLUG}

docker-vtag:
  stage: package
  tags:
    - dockerd
    - github
  # matches only on tags of the form vX.Y.Z
  only:
    - /^v(\d+\.)?(\d+\.)?(\d+)$/
  except:
    - branches
  image: docker:stable
  script:
    - docker build --tag rigetti/quilc:${CI_COMMIT_TAG} --tag rigetti/quilc:stable .
    - echo ${DOCKERHUB_PASSWORD} | docker login -u ${DOCKERHUB_USERNAME} --password-stdin
    - docker push rigetti/quilc && docker rmi -f rigetti/quilc:stable
